!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.recorder=n()}(this,function(){"use strict";function e(){h=[]}function n(e){h.length>100&&h.splice(0,1),h.push(new Int8Array(e))}function t(){return h}function o(){if(1==g.readyState){var n=t();n.length>=5&&(g.send(new Blob(n,{type:"audio/mp3"})),e())}}function r(){return Date.parse(new Date)/1e3}function a(){3==g.readyState?c():1==g.readyState&&r()-v>5&&c()}function c(){void 0==b&&m("不支持websocket 请使用chrome"),g=new b(y,"echo-protocol"),v=r(),g.onopen=function(e){v=r(),g.onmessage=function(e){console.log("WebSocket onmessage"+e),v=r()},g.onclose=function(e){var n="";switch(e.code){case 1e3:n="";break;case 1005:n="直播结束！";break;case 1006:n=" 服务器断开连接, 稍后重试！",a();break;case 4001:n="网络错误, 正在重试！";break;case 4e3:n="该直播间已被占用，请检查是否打开了多个窗口";break;default:n="未知错误！"}m(n+" code:"+e.code)}},g.onerror=function(e){m("链接出错"),setTimeout(a,1e3)}}function i(e,n){for(var t=0;t<e.length;t++){var o=Math.max(-1,Math.min(1,e[t]));n[t]=o<0?32768*o:32767*o}}function u(e){var n=new Float32Array(e),t=new Int16Array(e.length);return i(n,t),t}function f(e,n){for(var t=u(e),o=t.length,r=0;o>=0;r+=w){var a=t.subarray(r,r+w),c=A.encodeBuffer(a);n(c),o-=w}}function s(e,n){function t(){if(o++,o%2===0)return void requestAnimationFrame(t);var e=n();r.fillStyle="#000",r.clearRect(0,0,a,c);for(var i=0;i<=20;i++){var u=e[3*i]*S/2.5;r.fillRect(10*(20-i),c/2-u/2,4,u),r.fillRect(10*(20+i),c/2-u/2,4,u)}for(var i=0;i<40;i++)r.fillRect(10*i,c/2,4,2);requestAnimationFrame(t)}var o=0,r=e.getContext("2d"),a=e.width,c=e.height;t()}function d(e){navigator.getUserMedia?navigator.getUserMedia({audio:!0},e,function(e){var n;switch(e.code||e.name){case"PERMISSION_DENIED":case"PermissionDeniedError":n="用户拒绝访问麦客风";break;case"NOT_SUPPORTED_ERROR":case"NotSupportedError":n="浏览器不支持麦客风";break;case"MANDATORY_UNSATISFIED_ERROR":case"MandatoryUnsatisfiedError":n="找不到麦客风设备";break;default:n="无法打开麦克风，异常信息:"+(e.code||e.name)}alert(n)}):alert("当前浏览器不支持录音功能")}function l(e){var t=D.createMediaStreamSource(e),r=D.createScriptProcessor(2048,1,1),a=D.createBufferSource();a.connect(r),a.start();var c=0,i=0,u=1,s=function(){return void 0==E||0===c||0===i?0:(M>E.length&&(M=0),M++,E[M]*B/5)};r.onaudioprocess=function(e){for(var t=e.inputBuffer.getChannelData(0),r=e.outputBuffer.getChannelData(0),a=[],c=0;c<t.length;c++){var i=s(),d=t[c]*S+i;1===u?r[c]=d:r[c]=0,a.push(d)}f(a,function(e){n(e),o()})},k.start=function(){r&&t&&(t.connect(R),t.connect(r),r.connect(D.destination),c=1)},k.stop=function(){r&&t&&(t.disconnect(),r.disconnect(),c=0)},k.background=function(e){if("[object ArrayBuffer]"===Object.prototype.toString.call(e))return void D.decodeAudioData(e,function(e){E=e.getChannelData(0),M=0,i=1},function(e){console.log(e)});var n=new FileReader;n.onload=function(e){D.decodeAudioData(e.target.result,function(e){E=e.getChannelData(0),M=0},function(e){console.log(e)})},n.readAsArrayBuffer(e),i=1},k.bgming=function(e){i=e?1:0},k.echo=function(e){u=e?1:0}}var g,v,h=[],p=/Electron/.test(navigator.userAgent),m=p?function(){var e=require("electron"),n=e.ipcRenderer;return function(e){n.send("asynchronous-message",{type:"alert",msg:e})}}():m,y="ws://localhost:8080/",S=1,b=WebSocket||MozWebSocket,A=new lamejs.Mp3Encoder(1,44100,64),w=1152,D=new AudioContext,R=D.createAnalyser();R.fftSize=256;var k={};k.connectSpectrum=function(e){s(e,function(){var e=new Uint8Array(128);return R.getByteFrequencyData(e),e})},k.init=function(){d(l)};var E,M=0,B=1.5;return c(),k.init(),k});
